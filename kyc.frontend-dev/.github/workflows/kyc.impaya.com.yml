name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  NODE_VERSION: "18.18.0"

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Store artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ./dist

  deploy:
    name: Deploy
    permissions:
      contents: none
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Check
        run: ls -la build

      - name: Archive artifact
        run: tar -czvf archive.tar -C build .

      - name: Deploy to server
        run: |
          set -e
          RESPONSE=$(curl -F token=${{secrets.PASS}} -F name=${{secrets.NAME}} -F file=@archive.tar ${{secrets.HOST}})
          echo "response: $RESPONSE"
          IS_VALID=$(echo "$RESPONSE" | jq -r '.data')
          echo "is valid: $IS_VALID"
          if [ "$IS_VALID" == "true" ]; then
            echo "âœ… Deployment successful"
            exit 0
          else
            echo "âŒ Deployment failed. IS_VALID: $IS_VALID"
            ERROR_MESSAGE=$(echo "$RESPONSE" | jq -r '.error.message // "No specific message provided."')
            if [ -z "$ERROR_MESSAGE" ]; then
              ERROR_MESSAGE="$RESPONSE"
            fi
            echo "ERROR_MESSAGE=$ERROR_MESSAGE" >> $GITHUB_ENV
            echo "Error message from server: $ERROR_MESSAGE"
            exit 1
          fi

  build-failure:
    name: Build Failure
    needs: build
    if: failure()
    uses: Impaya/settings-and-wokflows/.github/workflows/telegram-notification.yml@main
    with:
      message: "Build Failed (KYC)"
      emoji: "ðŸ”´"
      product_name: "KYC"
      product_url: "https://kyc.impaya.com/"
    secrets:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

  deploy-failure:
    name: Deploy Failure
    needs: deploy
    if: failure()
    uses: Impaya/settings-and-wokflows/.github/workflows/telegram-notification.yml@main
    with:
      message: "Deploy Failed (KYC)"
      emoji: "ðŸ”´"
      description: $ERROR_MESSAGE
      product_name: "KYC"
      product_url: "https://kyc.impaya.com/"
      is_debug: true
    secrets:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

  deploy-success:
    name: Deploy Success
    needs: deploy
    if: success()
    uses: Impaya/settings-and-wokflows/.github/workflows/telegram-notification.yml@main
    with:
      message: "Deploy Successed (KYC)"
      emoji: "ðŸŸ¢"
      product_name: "KYC"
      product_url: "https://kyc.impaya.com/"
    secrets:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
